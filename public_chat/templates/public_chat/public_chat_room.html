{% load static %}
{% if debug %}
    PUBLIC CHAT
{% endif %}
<span class="{% if not debug %}d-none{% endif %} page-number" id="id_page_number">1</span>

<!-- Chat -->
<main class="main is-visible" data-dropzone-area="">
    <div class="container h-100">

        <div class="d-flex flex-column h-100 position-relative">
            <!-- Chat: Header -->
            <div class="chat-header border-bottom py-4 py-lg-7">
                <div class="row align-items-center">

                    <!-- Mobile: close -->
                    <div class="col-2 d-xl-none">
                        <a class="icon icon-lg text-muted" href="#" onclick="toggleMainClass()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-chevron-left">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </a>
                    </div>
                    <!-- Mobile: close -->

                    <!-- Content -->
                    <div class="col-8 col-xl-12">
                        <div class="row align-items-center text-center text-xl-start">
                            <!-- Title -->
                            <div class="col-12 col-xl-6">
                                <div class="row align-items-center gx-5">
                                    <div class="col-auto">
                                        <div class="avatar avatar-online d-none d-xl-inline-block">
                                            <img class="avatar-img" src="{% static 'img/dummy_image.png' %}"
                                                 id="id_group_image">
                                        </div>
                                    </div>

                                    <div class="col overflow-hidden">
                                        <h5 class="text-truncate" id="id_group_name"></h5>
                                        <p class="text-truncate" id="id_connected_users"></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Title -->

                            <!-- Toolbar -->
                            <div class="col-xl-6 d-none d-xl-block">
                                <div class="row align-items-center justify-content-end gx-6">
                                    <div class="col-auto">
                                        <a href="#" class="icon icon-lg text-muted" data-bs-toggle="offcanvas"
                                           data-bs-target="#offcanvas-more" aria-controls="offcanvas-more">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                 class="feather feather-more-horizontal">
                                                <circle cx="12" cy="12" r="1"></circle>
                                                <circle cx="19" cy="12" r="1"></circle>
                                                <circle cx="5" cy="12" r="1"></circle>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <!-- Toolbar -->
                        </div>
                    </div>
                    <!-- Content -->

                    <!-- Mobile: more -->
                    <div class="col-2 d-xl-none text-end">
                        <a href="#" class="icon icon-lg text-muted" data-bs-toggle="offcanvas"
                           data-bs-target="#offcanvas-more" aria-controls="offcanvas-more">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-more-vertical">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="12" cy="5" r="1"></circle>
                                <circle cx="12" cy="19" r="1"></circle>
                            </svg>
                        </a>
                    </div>
                    <!-- Mobile: more -->

                </div>
            </div>
            <!-- Chat: Header -->

            <!-- Chat: Content -->
            <div class="chat-body hide-scrollbar flex-1 h-100">
                <div class="chat-body-inner">
                    <!-- Loading Spinner -->
                    <div id="id_chatroom_loading_spinner" role="status" style="display: none;">
                        <div class="message message-out">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#modal-profile"
                               class="avatar avatar-responsive">
                                <svg class="avatar-img placeholder-img" width="100%" height="100%"
                                     xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder"
                                     preserveAspectRatio="xMidYMid slice" focusable="false">
                                    <title>Placeholder</title>
                                    <rect width="100%" height="100%" fill="#868e96"></rect>
                                </svg>
                            </a>

                            <div class="message-inner">
                                <div class="message-body">
                                    <div class="message-content">
                                        <div class="message-footer col">
                                            <div class="d-flex align-items-center mb-3 justify-content-end">
                                                <h5 class="placeholder-glow w-100 mb-0">
                                                    <span class="placeholder col-3"></span>
                                                </h5>
                                            </div>

                                            <div class="placeholder-glow">
                                                <span class="placeholder col-5"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="message-footer">
                                    <div class="placeholder-glow">
                                        <span class="placeholder col-2"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="message">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#modal-profile"
                               class="avatar avatar-responsive">
                                <svg class="avatar-img placeholder-img" width="100%" height="100%"
                                     xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder"
                                     preserveAspectRatio="xMidYMid slice" focusable="false">
                                    <title>Placeholder</title>
                                    <rect width="100%" height="100%" fill="#868e96"></rect>
                                </svg>
                            </a>

                            <div class="message-inner">
                                <div class="message-body">
                                    <div class="message-content">
                                        <div class="col">
                                            <div class="d-flex align-items-center mb-3">
                                                <h5 class="placeholder-glow w-100 mb-0">
                                                    <span class="placeholder col-3"></span>
                                                </h5>
                                            </div>

                                            <div class="placeholder-glow">
                                                <span class="placeholder col-5"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="message-footer">
                                    <div class="placeholder-glow">
                                        <span class="placeholder col-2"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Loading Spinner -->
                    <div class="d-flex py-6 py-lg-12" id="id_chat_log">
                    </div>
                </div>
            </div>
            <!-- Chat: Content -->

            <!-- Chat: Footer -->
            <div class="chat-footer pb-3 pb-lg-7 position-absolute bottom-0 start-0">
                <!-- Chat: Files -->
                <div class="dz-preview bg-dark" id="dz-preview-row" data-horizontal-scroll="">
                </div>
                <!-- Chat: Files -->

                <!-- Chat: Form -->
                <form class="chat-form rounded-pill bg-dark" data-emoji-form="">
                    <div class="row align-items-center gx-0">
                        <div class="col-auto">
                            <a href="#" class="btn btn-icon btn-link text-body rounded-circle" id="dz-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round" class="feather feather-paperclip">
                                    <path
                                            d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                    </path>
                                </svg>
                            </a>
                        </div>

                        <div class="col">
                            <div class="input-group">
                                <label for="id_chat_message_input"></label><textarea class="form-control px-0"
                                                                                     placeholder="Type your message..."
                                                                                     rows="1"
                                                                                     data-emoji-input=""
                                                                                     data-autosize="true"
                                                                                     id="id_chat_message_input"></textarea>

                                <a href="#" class="input-group-text text-body pe-0" data-emoji-btn="">
                                        <span class="icon icon-lg">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                 stroke-linecap="round" stroke-linejoin="round"
                                                 class="feather feather-smile">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                            </svg>
                                        </span>
                                </a>
                            </div>
                        </div>

                        <div class="col-auto">
                            <button class="btn btn-icon btn-primary rounded-circle ms-5" id="id_chat_message_submit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                     stroke-linejoin="round" class="feather feather-send">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>
                </form>
                <!-- Chat: Form -->
            </div>
            <!-- Chat: Footer -->
        </div>

    </div>
</main>
<!-- Chat -->
{% include 'components/chat-sideprofile.html' %}
<script type="text/javascript">
    var publicChatSocket = null;
    var roomId = null;

    onStart()

    function onStart() {
        {% if groups %}
            onSelectGroup("{{groups.0.room.id}}")
        {% endif %}

        {% for group in groups %}
            preloadImage("{{group.room.group_image.url|safe}}", "id_group_img_{{group.room.id}}")
        {% endfor %}
    }

    function onSelectGroup(roomId) {
        console.log("onSelectGroup: " + roomId)
        createOrReturnPublicChat(roomId)
        clearHighlightedGroup()
        highlightGroup(roomId)
        toggleMainClass()
    }

    function closeWebSocket() {
        if (publicChatSocket != null) {
            publicChatSocket.close()
            publicChatSocket = null
            clearChatLog()
            clearGroupUsers()
            setPageNumber("1")
            disableChatLogScrollListener()
        }
    }

    function setupWebSocket(room_id) {
        console.log("setupWebSocket: " + room_id)

        roomId = room_id

        // close previous socket if one is open
        closeWebSocket()

        // Correctly decide between ws:// and wss://
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        {% if debug_mode %}
            var ws_path = ws_scheme + '://' + window.location.host + "/public_chat/" + roomId + "/"; // development
        {% else %}
            var ws_path = ws_scheme + '://' + window.location.host + ":8001/public_chat/" + roomId + "/"; // production
        {% endif %}


        publicChatSocket = new WebSocket(ws_path);

        // Handle incoming messages
        publicChatSocket.onmessage = function (message) {
            console.log("Got chat websocket message " + message.data);
            var data = JSON.parse(message.data);

            // display the progress bar?
            displayChatroomLoadingSpinner(data.display_progress_bar)

            // Handle errors (ClientError)
            if (data.error) {
                console.error(data.error + ": " + data.message)
                showClientErrorModal(data.message)
                return;
            }
            // Handle joining (Client perspective)
            if (data.join) {
                console.log("Joining public room " + data.join);
                getGroupInfo()
                getRoomChatMessages()
                enableChatLogScrollListener()
            }
            // Handle leaving (client perspective)
            if (data.leave) {
                // do nothing
                console.log("Leaving room " + data.leave);
            }

            if (data.group_info) {
                handleGroupInfoPayload(data.group_info)
            }

            if (data.group_users) {
                handleGroupUsersPayload(data.group_users)
            }

            // Handle getting a message
            if (data.msg_type == 0) {
                appendChatMessage(data, true, true)
            }
            // Handle getting the connected_user count
            if (data.msg_type == 1) {
                console.log(data['connected_user_count'].group_use)
                setConnectedUsersCount(data['connected_user_count'])
            }
            // new payload of messages coming in from backend
            if (data.messages_payload) {
                console.log("PAYLOAD")
                handleMessagesPayload(data.messages, data.new_page_number)
            }
        };

        publicChatSocket.addEventListener("open", function (e) {
            console.log("Public Public ChatSocket OPEN")
            // join chat room
            if ("{{request.user.is_authenticated}}") {
                publicChatSocket.send(JSON.stringify({
                    "command": "join",
                    "room": roomId
                }));
            }
        })

        publicChatSocket.onclose = function (e) {
            console.error('Public ChatSocket closed.');
        };

        publicChatSocket.onOpen = function (e) {
            console.log("Public ChatSocket onOpen", e)
        }

        publicChatSocket.onerror = function (e) {
            console.log('Public ChatSocket error', e)
        }
        if (publicChatSocket.readyState == WebSocket.OPEN) {
            console.log("Public ChatSocket OPEN")
        } else if (publicChatSocket.readyState == WebSocket.CONNECTING) {
            console.log("Public ChatSocket connecting..")
        }
    }

    document.getElementById('id_chat_message_input').focus();
    document.getElementById('id_chat_message_input').onkeyup = function (e) {
        e.preventDefault()
        if (e.keyCode === 13 && e.shiftKey) {  // enter + return
            // Handled automatically by textarea
        } else if (e.keyCode === 13 && !e.shiftKey) { // enter + !return
            document.getElementById('id_chat_message_submit').click();
        }
    };

    document.getElementById('id_chat_message_submit').onclick = function (e) {
        e.preventDefault()
        const messageInputDom = document.getElementById('id_chat_message_input');
        const message = messageInputDom.value;
        publicChatSocket.send(JSON.stringify({
            "command": "send",
            "message": message,
            "room_id": roomId
        }));
        messageInputDom.value = '';
    };

    /*
           Retrieve the user information of the user other in the chat.
           1. Profile image
           2. username
           3. etc...
       */
    function getGroupInfo() {
        publicChatSocket.send(JSON.stringify({
            "command": "get_group_info",
            "room_id": roomId,
        }));
    }

    function handleGroupInfoPayload(group_info) {
        let groupName = document.querySelectorAll("#id_group_name")
        for (let i = 0; i < groupName.length; i++) {
            groupName[i].innerHTML = group_info['title'];
        }


        preloadImage(group_info['group_image'], "id_group_image")
        preloadImage(group_info['group_image'], "id_other_group_image")


        if (group_info['about'] != "") {
            let about = document.getElementById("id_group_about")
            about.innerHTML = group_info['about']
        }
    }

    function handleGroupUsersPayload(data) {
        for (let i = 0; i < data.length; i++) {
            console.log(data[i])
            user_id = data[i]['id']
            username = data[i]['username']
            profile_image = data[i]['profile_image']

            createGroupUserElement(user_id, username, profile_image)

        }
    }

    function createGroupUserElement(user_id, username, profile_image) {
        let usersContainer = document.getElementById("id_group_users_container")

        let userElement = document.createElement("li")
        userElement.classList.add("list-group-item")
        usersContainer.appendChild(userElement)

        let userBody = document.createElement("div")
        userBody.classList.add("row", "align-items-center", "gx-5")
        userElement.appendChild(userBody)

        // Avatar
        let userAvatar = document.createElement("div")
        userAvatar.classList.add("col-auto")
        userBody.appendChild(userAvatar)

        let userProfile = document.createElement("a")
        userProfile.classList.add("avatar", "avatar-online")
        userAvatar.appendChild(userProfile)

        let userImage = document.createElement("img")
        userImage.classList.add("avatar-img")
        userImage.src = profile_image
        userImage.style.cursor = "pointer"
        userImage.addEventListener("click", function (e) {
            selectUser(user_id)
        })

        userProfile.appendChild(userImage)

        // Text
        let userText = document.createElement("div")
        userText.classList.add("col")
        userBody.appendChild(userText)

        let userHeader = document.createElement("h5")
        if (user_id == "{{ request.user.id }}")
            userHeader.innerHTML = username + " ( You )"
        else {
            userHeader.innerHTML = username

        }
        userHeader.style.cursor = "pointer"
        userHeader.addEventListener("click", function (e) {
            selectUser(user_id)
        })
        userText.appendChild(userHeader)

        let userLink = document.createElement("a")
        userLink.classList.add("d-flex", "align-items-center")
        userLink.innerHTML = "View Profile"
        userLink.style.cursor = "pointer"

        userLink.addEventListener("click", function (e) {
            selectUser(user_id)
        })

        userText.appendChild(userLink)
    }

    function clearGroupUsers() {
        document.getElementById("id_group_users_container").innerHTML = ""
    }


    function appendChatMessage(data, maintainPosition, isNewMessage) {
        message = data['message']
        msg_id = data['msg_id']
        uName = data['username']
        user_id = data['user_id']
        profile_image = data['profile_image']
        timestamp = data['natural_timestamp']

        var msg = message;
        var username = uName;
        createChatMessageElement(msg, msg_id, username, profile_image, user_id, timestamp, maintainPosition, isNewMessage)

    }

    function createChatMessageElement(msg, msg_id, username, profile_image, user_id, timestamp, maintainPosition, isNewMessage) {
        var chatLog = document.getElementById("id_chat_log")

        var newMessageDiv = document.createElement("div")
        newMessageDiv.classList.add("message")

        var profileDiv = document.createElement("div")

        var profileButton = document.createElement("a")
        profileButton.classList.add("avatar", "avatar-responsive", "mx-auto", "mb-2")


        var profileImage = document.createElement("img")

        profileImage.classList.add("avatar-img")
        profileImage.src = "{% static 'img/dummy_image.png' %}"
        var profile_image_id = "id_profile_image_" + msg_id
        profileImage.id = profile_image_id


        var usernameSpan = document.createElement("div")
        usernameSpan.classList.add("text-muted", "text-center", "text-break")
        usernameSpan.style.width = "3.75rem"
        usernameSpan.innerHTML = username

        if (user_id == "{{ request.user.id }}") {
            newMessageDiv.classList.add("message-out")
            profileButton.setAttribute("data-bs-toggle", "modal")
            profileButton.setAttribute("data-bs-target", "#modal-profile")
            profileButton.setAttribute("aria-controls", "#modal-profile")

        } else {
            profileImage.addEventListener("click", function (e) {
                selectUser(user_id)
            })
            usernameSpan.addEventListener("click", function (e) {
                selectUser(user_id)
            })

        }

        newMessageDiv.appendChild(profileDiv)
        profileDiv.appendChild(profileButton)
        profileDiv.appendChild(usernameSpan)
        profileButton.appendChild(profileImage)

        var messageInner = document.createElement("div")
        messageInner.classList.add("message-inner")
        newMessageDiv.appendChild(messageInner)

        var messageBody = document.createElement("div")
        messageBody.classList.add("message-body")
        messageInner.appendChild(messageBody)

        var messageContent = document.createElement("div")
        messageContent.classList.add("message-content")
        messageBody.appendChild(messageContent)

        var messageText = document.createElement("div")
        messageText.classList.add("message-text")
        messageContent.appendChild(messageText)


        var msgP = document.createElement("p")
        msgP.innerHTML = validateText(msg)
        msgP.classList.add("text-break")
        messageText.appendChild(msgP)

        var messageFooter = document.createElement("div")
        messageFooter.classList.add("message-footer")
        messageInner.appendChild(messageFooter)


        var timestampSpan = document.createElement("span")
        timestampSpan.innerHTML = timestamp
        timestampSpan.id = "id_timestamp"
        timestampSpan.classList.add("extra-small", "text-muted")
        messageFooter.appendChild(timestampSpan)


        /*if (timestamp.includes("yesterday")) {
            var messageDivider = document.createElement("div")
            messageDivider.classList.add("message-divider")
            chatLog.appendChild(messageDivider)


            var divider = document.createElement("small")
            divider.classList.add("text-muted")
            divider.innerHTML = "Yesterday"
            messageDivider.appendChild(divider)
        }*/


        if (isNewMessage) {
            chatLog.insertBefore(newMessageDiv, chatLog.firstChild)
        } else {
            chatLog.appendChild(newMessageDiv)
        }

        if (!maintainPosition) {
            chatLog.scrollTop = chatLog.scrollHeight
        }

        // now that a default image is showing, load the actual image.
        preloadImage(profile_image, profile_image_id)

    }


    function setPageNumber(pageNumber) {
        document.getElementById("id_page_number").innerHTML = pageNumber
    }

    function clearChatLog() {
        document.getElementById("id_chat_log").innerHTML = ""
    }

    function setPaginationExhausted() {
        setPageNumber("-1")
    }

    /*
        Retrieve the chat room messages given the page number.
    */
    function getRoomChatMessages() {
        var pageNumber = document.getElementById("id_page_number").innerHTML
        if (pageNumber != "-1") {
            setPageNumber("-1") // Do not allow any other queries while one is in progress
            publicChatSocket.send(JSON.stringify({
                "command": "get_room_chat_messages",
                "room_id": roomId,
                "page_number": pageNumber,
            }));
        }
    }

    function handleMessagesPayload(messages, new_page_number) {
        if (messages != null && messages != "undefined" && messages != "None") {
            setPageNumber(new_page_number)
            messages.forEach(function (message) {
                appendChatMessage(message, true, false)
                let chatBox = document.getElementById("id_chat_log")
                chatBox.scrollTop = chatBox.scrollHeight;
            })
        } else {
            setPaginationExhausted() // no more messages
        }
    }


    /*
        Get the next page of chat messages when scrolls to bottom
    */
    function chatLogScrollListener(e) {
        var chatLog = document.getElementById("id_chat_log")
        if ((Math.abs(chatLog.scrollTop) + 2) >= (chatLog.scrollHeight - chatLog.offsetHeight)) {
            getRoomChatMessages()
        }
    }

    /*
            Enable the function "chatLogScrollListener"
        */
    function enableChatLogScrollListener() {
        document.getElementById("id_chat_log").addEventListener("scroll", chatLogScrollListener);
    }

    /*
        Disable the function "chatLogScrollListener"
    */
    function disableChatLogScrollListener() {
        document.getElementById("id_chat_log").removeEventListener("scroll", chatLogScrollListener)
    }

    function displayChatroomLoadingSpinner(isDisplayed) {
        var spinner = document.getElementById("id_chatroom_loading_spinner")
        if (isDisplayed) {
            spinner.style.display = "block"
        } else {
            spinner.style.display = "none"
        }
    }

    function highlightGroup(userId) {
        // select new friend
        document.getElementById("id_group_container_" + userId).style.background = "#0f79f4"
    }

    function clearHighlightedGroup() {
        {% if groups %}
            {% for group in groups %}
                document.getElementById("id_group_container_{{group.room.id}}").style.background = ""
            {% endfor %}
        {% endif %}

    }


    function selectUser(user_id) {
        if (user_id == "{{ request.user.id }}") {
            $('#modal-profile').modal('toggle')
        } else {
            var url = "{% url 'account:view' user_id=53252623623632623 %}".replace("53252623623632623", user_id)
            var win = window.open(url, "_self")
            win.focus()
        }

    }

    function showClientErrorModal(message) {
        document.getElementById("id_client_error_modal_body").innerHTML = message
        $('#id_client_error_modal').modal('toggle')
    }


    function setConnectedUsersCount(count) {
        let userCount = document.querySelectorAll("#id_connected_users")
        for (let i = 0; i < userCount.length; i++) {
            userCount[i].innerHTML = count + " Members Online"
        }

    }

    function createOrReturnPublicChat(id) {
        payload = {
            "csrfmiddlewaretoken": "{{ csrf_token }}",
            "public_room_id": id,
        }
        $.ajax({
            type: 'POST',
            dataType: "json",
            url: "{% url 'public_chat:create_public_chat' %}", // production
            data: payload,
            timeout: 5000,
            success: function (data) {
                console.log("SUCCESS", data)
                if (data['response'] == "Successfully got the chat.") {
                    setupWebSocket(data['chatroom_id'])
                } else if (data['response'] != null) {
                    alert(data['response'])
                }
            },
            error: function (data) {
                console.error("ERROR...", data)
                alert("Something went wrong.")
            },
        });
    }
</script>

{% include 'components/modal-error.html' %}